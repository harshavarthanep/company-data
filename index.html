<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PMO Master Suite | Enterprise V5 Production</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        corp: { 50: '#f8fafc', 100: '#f1f5f9', 800: '#1e293b', 900: '#0f172a' },
                        brand: { 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        .nav-item.active { background-color: #eff6ff; color: #2563eb; border-left: 4px solid #2563eb; }
        .hide { display: none !important; }
        .inp-std { width: 100%; padding: 0.6rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; font-size: 0.825rem; outline: none; transition: all 0.2s; background: white; }
        .inp-std:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .lbl-std { font-size: 0.65rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 0.25rem; display: block; letter-spacing: 0.05em; }
        .auth-bg { background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; }
        .card-header { border-bottom: 1px solid #f1f5f9; padding-bottom: 0.75rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; font-weight: 700; color: #334155; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="h-screen overflow-hidden bg-slate-50 flex flex-col">

    <div id="auth-layer" class="fixed inset-0 z-50 bg-white flex items-center justify-center auth-bg">
        <div class="w-full max-w-md p-8 bg-white shadow-2xl rounded-2xl border border-gray-100 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-indigo-600"></div>
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold tracking-tight text-corp-900">PMO<span class="text-brand-600">Master</span></h1>
                <p class="text-[10px] text-gray-500 mt-2 font-bold tracking-widest uppercase text-brand-600">Enterprise Suite V5</p>
            </div>
            <div id="form-login" class="space-y-4">
                <div><label class="lbl-std">Username</label><input type="text" id="login-user" class="inp-std" placeholder="admin / analyst"></div>
                <div><label class="lbl-std">Password</label><input type="password" id="login-pass" class="inp-std" placeholder="••••••••"></div>
                <button onclick="authLogin()" class="w-full bg-corp-900 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-gray-800 transition">Secure Sign In</button>
                <div class="flex items-center justify-between pt-4 border-t border-gray-100">
                    <button onclick="toggleAuth('signup')" class="text-xs text-brand-600 font-bold hover:underline">Register</button>
                    <button onclick="toggleAuth('guest')" class="text-xs text-gray-400 hover:text-gray-600 font-medium"><i class="fas fa-key mr-1"></i> Guest Pass</button>
                </div>
            </div>
            <div id="form-guest" class="space-y-4 hide">
                <div><label class="lbl-std">Guest Pass Key</label><input type="text" id="guest-token" class="inp-std font-mono text-center tracking-widest" placeholder="XXXX-XXXX"></div>
                <button onclick="authGuestToken()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">Verify & Access</button>
                <div class="text-center pt-2"><button onclick="toggleAuth('login')" class="text-xs text-gray-500">Back to Login</button></div>
            </div>
            <div id="form-signup" class="space-y-4 hide">
                <div><label class="lbl-std">Username</label><input type="text" id="sign-user" class="inp-std"></div>
                <div><label class="lbl-std">Role</label><select id="sign-role" class="inp-std bg-white"><option value="analyst">Analyst</option><option value="admin">Admin</option></select></div>
                <div><label class="lbl-std">Password (Min 6 chars)</label><input type="password" id="sign-pass" class="inp-std"></div>
                <button onclick="authSignup()" class="w-full bg-brand-600 text-white py-3 rounded-lg font-bold">Create Enterprise Account</button>
                <div class="text-center pt-2"><button onclick="toggleAuth('login')" class="text-xs text-gray-500">Back</button></div>
            </div>
        </div>
    </div>

    <div id="app-layer" class="flex-1 flex flex-col md:flex-row h-full overflow-hidden opacity-0 transition-opacity duration-500">
        <aside class="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col z-20 shadow-lg">
            <div class="p-6 border-b border-gray-100">
                <h1 class="text-xl font-bold tracking-tight text-corp-900">PMO<span class="text-brand-600">Master</span></h1>
                <div class="flex items-center mt-3 gap-2 bg-gray-50 px-2 py-1 rounded border border-gray-100 w-fit">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <p class="text-[10px] text-gray-600 font-bold tracking-wider uppercase" id="role-badge">SESSION</p>
                </div>
            </div>
            <nav class="flex-1 overflow-y-auto py-4 space-y-1">
                <a onclick="nav('dashboard')" id="nav-dashboard" class="nav-item active flex items-center px-6 py-3 text-sm font-medium cursor-pointer text-gray-600 hover:bg-gray-50 transition"><i class="fas fa-th-large w-6"></i> Dashboard</a>
                <a onclick="nav('analyze')" id="nav-analyze" class="nav-item flex items-center px-6 py-3 text-sm font-medium cursor-pointer text-gray-600 hover:bg-gray-50 transition"><i class="fas fa-search-dollar w-6"></i> Research & Edit</a>
                <a onclick="nav('visualize')" id="nav-visualize" class="nav-item flex items-center px-6 py-3 text-sm font-medium cursor-pointer text-gray-600 hover:bg-gray-50 transition"><i class="fas fa-chart-pie w-6"></i> Analytics</a>
                <a onclick="nav('settings')" id="nav-settings" class="nav-item flex items-center px-6 py-3 text-sm font-medium cursor-pointer text-gray-600 hover:bg-gray-50 transition"><i class="fas fa-cog w-6"></i> Settings</a>
            </nav>
            <div class="p-4 border-t border-gray-200">
                 <button onclick="logout()" class="w-full text-xs text-red-500 border border-red-100 bg-red-50 py-2.5 rounded hover:bg-red-100 font-semibold flex items-center justify-center gap-2"><i class="fas fa-sign-out-alt"></i> Sign Out</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full overflow-hidden relative w-full bg-slate-50">
            <header class="hidden md:flex h-16 bg-white border-b border-gray-200 items-center justify-between px-8 shrink-0 shadow-sm z-10">
                <h2 id="page-title" class="text-lg font-bold text-gray-800 uppercase tracking-tight">Dashboard</h2>
                <div class="flex items-center space-x-3 text-sm">
                    <div class="text-right leading-tight">
                        <div class="font-bold text-gray-800" id="display-user">User</div>
                        <div class="text-[10px] text-brand-600 font-bold" id="display-role">ROLE</div>
                    </div>
                    <div class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center border border-slate-200">
                        <i class="fas fa-user-shield text-slate-400"></i>
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-4 md:p-8 mobile-scroll" id="main-scroll">
                
                <div id="view-dashboard" class="space-y-6 max-w-7xl mx-auto">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                            <div class="text-[10px] text-gray-400 font-bold uppercase">Intelligence Pool</div>
                            <div class="text-3xl font-bold text-corp-900 mt-1" id="kpi-count">0</div>
                        </div>
                        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                            <div class="text-[10px] text-gray-400 font-bold uppercase">Estimated Value</div>
                            <div class="text-3xl font-bold text-green-600 mt-1" id="kpi-val">$0</div>
                        </div>
                        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                            <div class="text-[10px] text-gray-400 font-bold uppercase">Active Tokens</div>
                            <div class="text-3xl font-bold text-blue-600 mt-1" id="kpi-tokens">0</div>
                        </div>
                        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                            <div class="text-[10px] text-gray-400 font-bold uppercase">Data Points</div>
                            <div class="text-3xl font-bold text-indigo-600 mt-1" id="kpi-points">0</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                            <h3 class="font-bold text-gray-800">Company Intelligence Directory</h3>
                            <button id="btn-add-new" onclick="nav('analyze')" class="text-xs bg-brand-600 text-white px-4 py-2 rounded font-bold shadow-sm hover:bg-brand-700 transition"><i class="fas fa-plus mr-1"></i> New Entry</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50 text-gray-500 border-b uppercase text-[10px] tracking-wider">
                                    <tr>
                                        <th class="px-6 py-4 font-bold">Company Profile</th>
                                        <th class="px-6 py-4 font-bold">Leadership</th>
                                        <th class="px-6 py-4 font-bold">HQ / Status</th>
                                        <th class="px-6 py-4 font-bold">Value</th>
                                        <th class="px-6 py-4 font-bold">Owner</th>
                                        <th class="px-6 py-4 font-bold text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="view-analyze" class="hide max-w-6xl mx-auto pb-24">
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div class="lg:col-span-2 bg-white rounded-xl border border-gray-200 p-6">
                            <div class="card-header"><i class="fas fa-bolt text-yellow-500"></i> AI Smart Extract</div>
                            <textarea id="paste-area" class="w-full h-32 p-3 bg-slate-50 border border-slate-200 rounded-lg text-xs outline-none focus:ring-2 focus:ring-brand-500" placeholder="Paste News, LinkedIn bio, or Company Info here to auto-fill forms..."></textarea>
                            <div class="mt-3 flex gap-2">
                                <button onclick="smartParse()" class="bg-brand-600 text-white px-4 py-2 rounded text-xs font-bold hover:bg-brand-700">Auto-Fill Form</button>
                                <button onclick="resetForm()" class="text-gray-500 px-4 py-2 text-xs font-bold border border-gray-200 rounded">Reset Form</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl border border-gray-200 p-6">
                            <div class="card-header"><i class="fas fa-search-plus text-blue-500"></i> Intelligence Links</div>
                            <input type="text" id="search-input" class="inp-std mb-3" placeholder="Company Name">
                            <button onclick="runDiscovery()" class="w-full bg-slate-900 text-white py-2 rounded text-xs font-bold">Generate All Discovery Links</button>
                            <div id="discovery-panel" class="mt-4 grid grid-cols-2 gap-2 hidden"></div>
                        </div>
                    </div>

                    <form id="main-form" class="space-y-6">
                        <input type="hidden" id="entry-id">
                        
                        <div class="bg-white rounded-xl border border-gray-200 p-6 relative">
                            <div class="card-header text-brand-600"><i class="fas fa-id-badge"></i> Corporate Identity & HQ</div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div><label class="lbl-std">Company Name</label><input type="text" id="inp-name" required class="inp-std"></div>
                                <div><label class="lbl-std">Website</label><input type="text" id="inp-web" class="inp-std"></div>
                                <div><label class="lbl-std">Headquarters (City/Country)</label><input type="text" id="inp-hq" class="inp-std"></div>
                                <div><label class="lbl-std">Parent Company</label><input type="text" id="inp-parent" class="inp-std"></div>
                                <div><label class="lbl-std">Launch Year</label><input type="text" id="inp-launch" class="inp-std"></div>
                                <div><label class="lbl-std">Valuation / Revenue</label><input type="text" id="inp-rev" class="inp-std font-bold text-green-700"></div>
                            </div>
                            <div class="mt-4"><label class="lbl-std">Founder & Current CEO</label><input type="text" id="inp-ceo" class="inp-std"></div>
                            <div class="mt-4"><label class="lbl-std">Company Mission (What they do)</label><textarea id="inp-desc" rows="2" class="inp-std"></textarea></div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-white rounded-xl border border-gray-200 p-6">
                                <div class="card-header text-emerald-600"><i class="fas fa-cubes"></i> Product & Market Play</div>
                                <div class="space-y-4">
                                    <div><label class="lbl-std">Key Products</label><textarea id="inp-products" rows="3" class="inp-std"></textarea></div>
                                    <div><label class="lbl-std">Market Standing (USP)</label><textarea id="inp-usp" rows="2" class="inp-std"></textarea></div>
                                    <div><label class="lbl-std">Geographic Coverage</label><input type="text" id="inp-market" class="inp-std"></div>
                                </div>
                            </div>
                            <div class="bg-white rounded-xl border border-gray-200 p-6">
                                <div class="card-header text-purple-600"><i class="fas fa-sitemap"></i> Ecosystem & Structure</div>
                                <div class="space-y-4">
                                    <div><label class="lbl-std">Subsidiaries & M&A</label><textarea id="inp-sub" rows="3" class="inp-std"></textarea></div>
                                    <div><label class="lbl-std">Current Partnerships & Tech Stack</label><textarea id="inp-tech" rows="3" class="inp-std"></textarea></div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl border border-gray-200 p-6">
                            <div class="card-header text-orange-600"><i class="fas fa-users-cog"></i> Org Chart & Personnel Intel</div>
                            <textarea id="inp-orgchart" rows="5" class="inp-std font-mono" placeholder="Format: [Name | Designation | Recent Activity | Callouts]"></textarea>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-white rounded-xl border border-gray-200 p-6">
                                <div class="card-header text-red-600"><i class="fas fa-swords"></i> Competitive Intel</div>
                                <div><label class="lbl-std">Competitor Landscape (Both iOPEX & Client)</label><textarea id="inp-comp_client" rows="4" class="inp-std"></textarea></div>
                            </div>
                            <div class="bg-white rounded-xl border border-gray-200 p-6">
                                <div class="card-header text-blue-600"><i class="fas fa-calendar-alt"></i> Events & Hiring</div>
                                <div class="space-y-4">
                                    <div><label class="lbl-std">Recent Openings / Job Focus</label><textarea id="inp-hiring" rows="2" class="inp-std"></textarea></div>
                                    <div><label class="lbl-std">Event Calendar</label><textarea id="inp-events" rows="2" class="inp-std"></textarea></div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl border border-gray-200 p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-bold text-slate-800 text-sm uppercase">Additional Manual Intelligence</h4>
                                <button type="button" onclick="addCustomField()" class="text-xs bg-brand-50 text-brand-600 px-3 py-1.5 rounded-lg font-bold border border-brand-100 hover:bg-brand-100"><i class="fas fa-plus mr-1"></i> Add Custom Field</button>
                            </div>
                            <div id="custom-fields-container" class="space-y-4"></div>
                        </div>

                        <div class="flex items-center justify-between sticky bottom-4 bg-white p-4 rounded-xl shadow-2xl border border-gray-200 z-20">
                            <button type="button" onclick="nav('dashboard')" class="text-xs font-bold text-gray-400">DISCARD CHANGES</button>
                            <button type="submit" class="bg-corp-900 text-white px-10 py-3 rounded-lg font-bold shadow-lg transform hover:scale-105 transition">SYNC TO CLOUD DB</button>
                        </div>
                    </form>
                </div>

                <div id="view-settings" class="hide max-w-4xl mx-auto space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <div class="bg-white p-8 rounded-xl border border-gray-200 shadow-sm">
                            <div class="card-header text-brand-600"><i class="fas fa-user-lock"></i> Account Credentials</div>
                            <div class="space-y-4">
                                <div><label class="lbl-std">New Username</label><input type="text" id="upd-user" class="inp-std"></div>
                                <div><label class="lbl-std">New Password</label><input type="password" id="upd-pass" class="inp-std" placeholder="Leave blank to keep current"></div>
                                <button onclick="updateProfile()" class="w-full bg-slate-900 text-white py-2 rounded text-xs font-bold">Update Account Info</button>
                            </div>
                        </div>

                        <div class="bg-white p-8 rounded-xl border border-gray-200 shadow-sm">
                            <div class="card-header text-emerald-600"><i class="fas fa-database"></i> Database Utility</div>
                            <div class="space-y-3">
                                <button onclick="backupData()" class="w-full bg-corp-900 text-white py-2.5 rounded text-xs font-bold"><i class="fas fa-download mr-2"></i> Export Full DB (Backup)</button>
                                <div class="relative py-2"><div class="absolute inset-0 flex items-center"><div class="w-full border-t"></div></div></div>
                                <label class="lbl-std">Import Backup</label>
                                <input type="file" id="import-file" onchange="importData(this)" class="text-[10px] text-slate-500">
                            </div>
                        </div>

                    </div>

                    <div class="bg-white p-8 rounded-xl border border-gray-200 shadow-sm">
                        <div class="card-header text-blue-600"><i class="fas fa-share-nodes"></i> Secure Token Center</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <label class="lbl-std">Set Custom Expiration (Date & Time)</label>
                                <input type="datetime-local" id="share-custom-date" class="inp-std mb-4">
                                <button onclick="generateToken()" class="w-full bg-blue-600 text-white py-3 rounded font-bold shadow-md hover:bg-blue-700">Generate Guest Pass Key</button>
                            </div>
                            <div id="token-display" class="hidden bg-slate-50 p-6 rounded-xl border-2 border-dashed border-slate-200 flex flex-col items-center justify-center">
                                <div class="text-[10px] font-bold text-gray-400 uppercase mb-1">Pass Key</div>
                                <div id="gen-code" class="text-3xl font-black text-slate-800 tracking-widest mb-4"></div>
                                <div class="w-full">
                                    <label class="lbl-std">Shareable Link</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="gen-link" class="flex-1 text-[10px] p-2 bg-white border border-slate-200" readonly>
                                        <button onclick="copyLink()" class="bg-slate-200 px-3 text-xs font-bold rounded">Copy</button>
                                    </div>
                                    <p class="text-[10px] text-blue-600 mt-2 font-bold" id="gen-exp-info"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="admin-zone" class="bg-red-50 p-8 rounded-xl border border-red-100 hidden">
                        <h4 class="text-red-600 font-black text-xs uppercase mb-2">Master Reset</h4>
                        <button onclick="clearAllData()" class="w-full text-xs text-red-500 border border-red-200 bg-white py-3 rounded font-bold hover:bg-red-500 hover:text-white transition">DELETE ALL USERS & DATA</button>
                    </div>
                </div>

                <div id="view-visualize" class="hide max-w-6xl mx-auto">
                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm h-[500px] flex flex-col">
                        <h3 class="font-bold text-gray-800 mb-6">Enterprise Valuation Landscape</h3>
                        <div class="flex-1 min-h-0"><canvas id="chart-valuation"></canvas></div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div id="view-modal" class="fixed inset-0 z-50 bg-slate-900/70 hidden flex justify-end">
        <div class="w-full max-w-3xl h-full bg-white shadow-2xl overflow-y-auto relative animate-fade">
            <div class="sticky top-0 bg-white border-b p-6 flex justify-between items-center z-10">
                <div>
                    <h2 id="vm-name" class="text-2xl font-black text-slate-900">Company</h2>
                    <div class="flex gap-2 text-[10px] font-bold text-slate-400 uppercase"><span id="vm-parent"></span> | <span id="vm-hq"></span></div>
                </div>
                <div class="flex gap-2">
                    <button id="vm-btn-edit" class="bg-brand-600 text-white px-4 py-2 rounded text-xs font-bold">EDIT REPORT</button>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-slate-900 px-3 text-2xl">&times;</button>
                </div>
            </div>
            <div class="p-8 space-y-8">
                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-slate-50 p-4 rounded-lg"><label class="lbl-std">CEO</label><div id="vm-ceo" class="text-sm font-bold"></div></div>
                    <div class="bg-green-50 p-4 rounded-lg"><label class="lbl-std text-green-600">Valuation</label><div id="vm-rev" class="text-sm font-bold text-green-700"></div></div>
                    <div class="bg-slate-50 p-4 rounded-lg"><label class="lbl-std">Launch</label><div id="vm-launch" class="text-sm font-bold"></div></div>
                </div>
                <section>
                    <h4 class="text-xs font-black text-brand-600 border-b pb-2 mb-4 uppercase">Market Standing</h4>
                    <p id="vm-desc" class="text-xs text-slate-600 leading-relaxed mb-4"></p>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="lbl-std">USP</label><p id="vm-usp" class="text-xs font-bold"></p></div>
                        <div><label class="lbl-std">Coverage</label><p id="vm-market" class="text-xs font-bold"></p></div>
                    </div>
                </section>
                <section>
                    <h4 class="text-xs font-black text-emerald-600 border-b pb-2 mb-4 uppercase">Portfolio & Ecosystem</h4>
                    <div class="space-y-4">
                        <div><label class="lbl-std">Products</label><p id="vm-products" class="text-xs whitespace-pre-line"></p></div>
                        <div><label class="lbl-std">Subsidiaries</label><p id="vm-sub" class="text-xs whitespace-pre-line"></p></div>
                    </div>
                </section>
                <div class="bg-slate-900 p-6 rounded-xl text-slate-100">
                    <h4 class="text-[10px] font-black text-blue-400 uppercase mb-3">Technology Stack</h4>
                    <p id="vm-tech" class="text-xs whitespace-pre-line leading-relaxed"></p>
                </div>
                <section>
                    <h4 class="text-xs font-black text-orange-600 border-b pb-2 mb-4 uppercase">Org Chart Intel</h4>
                    <div id="vm-orgchart" class="bg-slate-50 p-4 rounded-lg font-mono text-xs whitespace-pre-line"></div>
                </section>
                <div id="vm-custom-area" class="space-y-6"></div>
                
                <div class="grid grid-cols-2 gap-8">
                    <section><h4 class="text-xs font-black text-red-600 border-b pb-2 mb-2 uppercase">Competitors</h4><p id="vm-comp_client" class="text-xs"></p></section>
                    <section><h4 class="text-xs font-black text-blue-600 border-b pb-2 mb-2 uppercase">Hiring & PR</h4><p id="vm-hiring" class="text-xs"></p></section>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CORE DATA ---
        let db = JSON.parse(localStorage.getItem('pmo_master_db')) || [];
        let users = JSON.parse(localStorage.getItem('pmo_users')) || [{ user: 'admin', pass: 'admin', role: 'admin' }];
        let validTokens = JSON.parse(localStorage.getItem('pmo_tokens')) || [];
        let session = null;

        // --- 2. AUTHENTICATION (REBUILT) ---
        function toggleAuth(v) { 
            document.querySelectorAll('#auth-layer > div > div').forEach(e=>e.classList.add('hide'));
            document.getElementById(`form-${v}`).classList.remove('hide'); 
        }

        function authLogin() {
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value.trim();
            const v = users.find(x=>x.user===u && x.pass===p);
            if(v) startSession(v); else alert("Invalid Credentials.");
        }

        function authSignup() {
            const u = document.getElementById('sign-user').value.trim();
            const p = document.getElementById('sign-pass').value.trim();
            const r = document.getElementById('sign-role').value;
            if(!u || p.length < 6) return alert("Username required. Password must be 6+ chars.");
            if(users.find(x=>x.user===u)) return alert("User exists.");
            const n = { user: u, pass: p, role: r };
            users.push(n);
            localStorage.setItem('pmo_users', JSON.stringify(users));
            startSession(n);
        }

        function authGuestToken() {
            const t = document.getElementById('guest-token').value.trim();
            const now = Date.now();
            const match = validTokens.find(x => x.code === t && (x.exp === 0 || x.exp > now));
            if(match) startSession({ user: 'Guest', role: 'guest' });
            else alert("Pass Key is invalid or has expired.");
        }

        function startSession(u) {
            session = u;
            document.getElementById('auth-layer').classList.add('hide');
            document.getElementById('app-layer').classList.remove('opacity-0');
            document.getElementById('display-user').innerText = session.user;
            document.getElementById('display-role').innerText = session.role.toUpperCase();
            document.getElementById('upd-user').value = session.user;

            if(session.role==='admin') document.getElementById('admin-zone').classList.remove('hidden');
            if(session.role==='guest') {
                document.getElementById('nav-analyze').classList.add('hide');
                document.getElementById('btn-add-new').classList.add('hide');
            }
            renderTable(); updateKPIs(); nav('dashboard');
        }

        function updateProfile() {
            const newU = document.getElementById('upd-user').value;
            const newP = document.getElementById('upd-pass').value;
            const idx = users.findIndex(x=>x.user===session.user);
            if(idx > -1) {
                users[idx].user = newU;
                if(newP) users[idx].pass = newP;
                localStorage.setItem('pmo_users', JSON.stringify(users));
                alert("Security Credentials Updated. Please logout.");
            }
        }

        function logout() { location.reload(); }

        // --- 3. DASHBOARD & DATA ---
        function renderTable() {
            const b = document.getElementById('table-body'); b.innerHTML = '';
            db.forEach(r => {
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-slate-50 transition cursor-pointer";
                tr.onclick = (e) => { if(!e.target.closest('button')) openViewModal(r.id); };
                
                const canEdit = session.role === 'admin' || r.author === session.user;
                tr.innerHTML = `
                    <td class="px-6 py-4"><div class="font-bold text-slate-900">${r.name}</div><div class="text-[10px] text-blue-500 font-bold">${r.web || '-'}</div></td>
                    <td class="px-6 py-4 text-xs font-bold text-slate-600">${r.ceo || '-'}</td>
                    <td class="px-6 py-4"><div class="text-xs font-bold">${r.hq || '-'}</div><div class="text-[9px] text-slate-400 font-bold uppercase">${r.parent || 'Standalone'}</div></td>
                    <td class="px-6 py-4 text-xs font-black text-emerald-600">${r.rev || '-'}</td>
                    <td class="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase">${r.author}</td>
                    <td class="px-6 py-4 text-right space-x-1">
                        ${canEdit ? `<button onclick="edit('${r.id}')" class="text-blue-600 p-2 hover:bg-blue-50 rounded"><i class="fas fa-edit"></i></button>` : ''}
                        <button onclick="exportWord('${r.id}')" class="text-indigo-600 p-2 hover:bg-indigo-50 rounded"><i class="fas fa-file-word"></i></button>
                        ${canEdit ? `<button onclick="del('${r.id}')" class="text-red-400 p-2 hover:bg-red-50 rounded"><i class="fas fa-trash"></i></button>` : ''}
                    </td>`;
                b.appendChild(tr);
            });
        }

        // --- 4. FORM LOGIC ---
        function smartParse() {
            const t = document.getElementById('paste-area').value;
            const map = {
                'inp-name': [/Company:\s*(.*)/i, /Name:\s*(.*)/i, /(.*?) Ltd/i],
                'inp-ceo': [/CEO:\s*(.*)/i, /Founder:\s*(.*)/i, /CEO is\s*(.*)/i],
                'inp-hq': [/Headquarters:\s*(.*)/i, /based in\s*(.*)/i, /HQ:\s*(.*)/i],
                'inp-rev': [/revenue of\s*(.*)/i, /valuation:\s*(.*)/i, /worth\s*(.*)/i],
                'inp-launch': [/launched in\s*(\d{4})/i, /founded in\s*(\d{4})/i]
            };
            for(let id in map) {
                for(let reg of map[id]) {
                    let m = t.match(reg);
                    if(m && m[1]) { document.getElementById(id).value = m[1].split('.')[0].trim(); break; }
                }
            }
        }

        function addCustomField(data = null) {
            const id = Date.now();
            const div = document.createElement('div');
            div.className = "p-4 bg-slate-50 border rounded-lg relative";
            div.id = `cf-${id}`;
            div.innerHTML = `
                <button type="button" onclick="this.parentElement.remove()" class="absolute top-2 right-2 text-red-300 hover:text-red-600"><i class="fas fa-times-circle"></i></button>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                    <input type="text" class="cf-title inp-std font-bold" placeholder="Heading (e.g. Risk Assessment)" value="${data?data.t:''}">
                    <input type="text" class="cf-sub inp-std" placeholder="Sub-heading (Optional)" value="${data?data.s:''}">
                </div>
                <textarea class="cf-content inp-std" rows="3" placeholder="Content...">${data?data.c:''}</textarea>
            `;
            document.getElementById('custom-fields-container').appendChild(div);
        }

        document.getElementById('main-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const get = (id) => document.getElementById(id).value;
            
            // Build Custom Data
            const custom = [];
            document.querySelectorAll('#custom-fields-container > div').forEach(d => {
                custom.push({ t: d.querySelector('.cf-title').value, s: d.querySelector('.cf-sub').value, c: d.querySelector('.cf-content').value });
            });

            const rec = {
                id: document.getElementById('entry-id').value || Date.now().toString(),
                author: session.user, updated: new Date().toLocaleDateString(),
                name: get('inp-name'), web: get('inp-web'), hq: get('inp-hq'), parent: get('inp-parent'), launch: get('inp-launch'), rev: get('inp-rev'), ceo: get('inp-ceo'), desc: get('inp-desc'),
                products: get('inp-products'), usp: get('inp-usp'), market: get('inp-market'), sub: get('inp-sub'), tech: get('inp-tech'),
                orgchart: get('inp-orgchart'), comp_client: get('inp-comp_client'), hiring: get('inp-hiring'), events: get('inp-events'),
                custom: custom
            };

            const idx = db.findIndex(x=>x.id===rec.id);
            if(idx>-1) db[idx]=rec; else db.push(rec);
            localStorage.setItem('pmo_master_db', JSON.stringify(db));
            resetForm(); nav('dashboard'); renderTable(); updateKPIs();
        });

        // --- 5. TOKEN & SHARING (STRICT FIX) ---
        function generateToken() {
            const expiryInput = document.getElementById('share-custom-date').value;
            if(!expiryInput) return alert("Please select a Date and Time for expiration first.");
            
            const expiryTime = new Date(expiryInput).getTime();
            if(expiryTime <= Date.now()) return alert("Expiration must be in the future.");

            const code = Math.random().toString(36).substring(2, 6).toUpperCase() + '-' + Math.random().toString(36).substring(2, 6).toUpperCase();
            const newToken = { code: code, exp: expiryTime, by: session.user };
            
            validTokens.push(newToken);
            localStorage.setItem('pmo_tokens', JSON.stringify(validTokens));

            document.getElementById('token-display').classList.remove('hide');
            document.getElementById('gen-code').innerText = code;
            document.getElementById('gen-exp-info').innerText = `Valid until: ${new Date(expiryTime).toLocaleString()}`;
            document.getElementById('gen-link').value = `${location.href.split('?')[0]}?key=${code}`;
        }

        // --- 6. UTILS ---
        function nav(id) { 
            document.querySelectorAll('[id^="view-"]').forEach(e=>e.classList.add('hide')); 
            document.getElementById(`view-${id}`).classList.remove('hide'); 
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            const l = document.getElementById(`nav-${id}`); if(l) l.classList.add('active');
            if(id==='visualize') renderChart();
        }

        function resetForm() { document.getElementById('main-form').reset(); document.getElementById('entry-id').value=''; document.getElementById('custom-fields-container').innerHTML=''; }
        function closeModal() { document.getElementById('view-modal').classList.add('hidden'); }

        function openViewModal(id) {
            const r = db.find(x=>x.id===id);
            for(let k in r) { const el = document.getElementById(`vm-${k}`); if(el) el.innerText = r[k] || '-'; }
            
            // Custom Area View
            const area = document.getElementById('vm-custom-area'); area.innerHTML = '';
            if(r.custom) r.custom.forEach(c => {
                const d = document.createElement('div');
                d.innerHTML = `<h4 class="text-xs font-black text-slate-800 border-b pb-1 mb-2 uppercase">${c.t} <span class="text-slate-400 ml-2">${c.s}</span></h4><p class="text-xs text-slate-600">${c.c}</p>`;
                area.appendChild(d);
            });

            const b = document.getElementById('vm-btn-edit');
            if(session.role==='admin'||r.author===session.user) { b.classList.remove('hide'); b.onclick=()=>{closeModal(); edit(r.id);}; } else b.classList.add('hide');
            document.getElementById('view-modal').classList.remove('hidden');
        }

        function edit(id) { 
            const r = db.find(x=>x.id===id); 
            document.getElementById('entry-id').value = r.id; 
            for(let k in r) { const el = document.getElementById(`inp-${k}`); if(el) el.value = r[k] || ''; }
            if(r.custom) r.custom.forEach(c => addCustomField(c));
            nav('analyze'); 
        }

        function del(id) { if(confirm("Delete report?")) { db = db.filter(x=>x.id!==id); localStorage.setItem('pmo_master_db', JSON.stringify(db)); renderTable(); updateKPIs(); } }

        function updateKPIs() {
            document.getElementById('kpi-count').innerText = db.length;
            document.getElementById('kpi-points').innerText = db.length * 20;
            const now = Date.now();
            const activeTokens = validTokens.filter(t => t.exp === 0 || t.exp > now).length;
            document.getElementById('kpi-tokens').innerText = activeTokens;
            let t = 0; db.forEach(r=>{if(r.rev){ let n = parseFloat(r.rev.replace(/[^0-9.]/g,'')); if(!isNaN(n)) t+= r.rev.includes('B')?n*1000:n; }});
            document.getElementById('kpi-val').innerText = t>=1000?`$${(t/1000).toFixed(1)}B`:`$${t}M`;
        }

        function runDiscovery() {
            const n = document.getElementById('search-input').value; if(!n) return;
            const p = document.getElementById('discovery-panel'); p.classList.remove('hidden'); p.innerHTML = '';
            const lks = [
                {t:"LinkedIn", q:`site:linkedin.com/company "${n}"`},
                {t:"Tech Stack", q:`site:builtwith.com "${n}"`},
                {t:"Org Chart", q:`site:theorg.com "${n}"`},
                {t:"Financials", q:`"${n}" annual revenue 2026 valuation`},
                {t:"Hiring", q:`site:glassdoor.com "${n}" careers`},
                {t:"Competitors", q:`top competitors for "${n}"`}
            ];
            lks.forEach(l => {
                const a = document.createElement('a'); a.href=`https://www.google.com/search?q=${encodeURIComponent(l.q)}`; a.target="_blank";
                a.className = "p-2 bg-slate-50 border rounded text-[10px] font-bold text-center hover:bg-white transition";
                a.innerText = l.t; p.appendChild(a);
            });
        }

        // --- 7. EXPORTS & BACKUP ---
        function backupData() {
            const data = { db, users, tokens: validTokens };
            saveAs(new Blob([JSON.stringify(data, null, 2)], {type:"application/json"}), "PMO_MASTER_BACKUP.json");
        }

        function importData(input) {
            const reader = new FileReader();
            reader.onload = function(){
                const data = JSON.parse(reader.result);
                if(data.db) {
                    db = data.db; users = data.users || users; validTokens = data.tokens || [];
                    localStorage.setItem('pmo_master_db', JSON.stringify(db));
                    localStorage.setItem('pmo_users', JSON.stringify(users));
                    localStorage.setItem('pmo_tokens', JSON.stringify(validTokens));
                    alert("Import Successful. Refreshing...");
                    location.reload();
                }
            };
            reader.readAsText(input.files[0]);
        }

        function exportWord(id) {
            const r = db.find(x=>x.id===id);
            let customH = '';
            if(r.custom) r.custom.forEach(c => { customH += `<h3 style="background:#f1f5f9;padding:5px;">${c.t}</h3><p>${c.c}</p>`; });
            const html = `<html><body><h1 style="color:#2563eb">${r.name}</h1><p><b>CEO:</b> ${r.ceo} | <b>Valuation:</b> ${r.rev}</p><h2>About</h2><p>${r.desc}</p><h2>Technology</h2><p>${r.tech}</p>${customH}</body></html>`;
            saveAs(new Blob([html], {type:"application/msword"}), `${r.name}_Analysis.doc`);
        }

        function renderChart() {
            const ctx = document.getElementById('chart-valuation').getContext('2d');
            const labels = db.map(x=>x.name);
            const vals = db.map(r=>{ let n = parseFloat((r.rev||"0").replace(/[^0-9.]/g,'')); return r.rev&&r.rev.includes('B')?n*1000:n; });
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, { type:'bar', data: {labels:labels, datasets:[{label:'Value (Millions)', data:vals, backgroundColor:'#3b82f6', borderRadius:5}]}, options:{responsive:true, maintainAspectRatio:false}});
        }

        function clearAllData() { if(confirm("Wipe Everything?")) { localStorage.clear(); location.reload(); } }
        function copyLink() { const i = document.getElementById('gen-link'); i.select(); document.execCommand('copy'); alert('Copied'); }
    </script>
</body>
</html>
